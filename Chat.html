<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Chat</title>
<link rel="stylesheet" href="chat_styles.css">
</head>
<body>
<header>
    <button id="backBtn">â¬…</button>
    <span id="chatWith">Chat</span>
</header>
<div id="messages"></div>
<div class="typingIndicator" id="typing"></div>
<div id="inputContainer">
<input type="text" id="msg" placeholder="Type a message">
<button id="sendBtn">Send</button>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const otherId = params.get('user_id');
const otherName = params.get('name');
document.getElementById('chatWith').innerText = otherName;

document.getElementById('backBtn').addEventListener('click', ()=>{
    const last = sessionStorage.getItem('lastPage') || 'contacts.html';
    window.location.href = last;
});

async function api(path,opt={}){ 
    const r = await fetch(path,{credentials:'same-origin',headers:{'Content-Type':'application/json'},...opt}); 
    return r.json(); 
}

let typingTimeout;
function showTyping(){
    document.getElementById('typing').innerText='Typing...';
    clearTimeout(typingTimeout);
    typingTimeout=setTimeout(()=>document.getElementById('typing').innerText='',1000);
}

async function loadMessages(){
    const r = await api('fetch_messages.php?user_id='+otherId);
    const container = document.getElementById('messages');
    container.innerHTML='';
    r.messages.forEach(m=>{
        const div=document.createElement('div');
        const avatar = m.sender_avatar ? `<img src="${m.sender_avatar}" class="avatar">` : '';
        div.className = m.sender_id==<?php echo $_SESSION['user_id'] ?? 0 ?>?'message sent':'message received';
        div.innerHTML = `${avatar}<span>${m.message}</span><span class="timestamp">${new Date(m.created_at).toLocaleTimeString()}</span>`;
        container.appendChild(div);
    });
    container.scrollTop = container.scrollHeight;
}

document.getElementById('msg').addEventListener('input', showTyping);

document.getElementById('sendBtn').addEventListener('click', async ()=>{
    const text=document.getElementById('msg').value;
    if(!text) return;
    await api('send_message.php',{method:'POST',body:JSON.stringify({receiver_id:otherId,message:text})});
    document.getElementById('msg').value='';
    loadMessages();
});

setInterval(loadMessages,2000);
loadMessages();
</script>
</body>
</html>
