<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Contacts</title>
<link rel="stylesheet" href="chat_styles.css">
</head>
<body>
<header><h2>Contacts</h2></header>
<input type="text" id="search" placeholder="Search users...">
<div id="userList"></div>

<script>
async function fetchUsers(q=''){
    const res = await fetch('fetch_users.php?q='+encodeURIComponent(q), {credentials:'same-origin'});
    const data = await res.json();
    const container = document.getElementById('userList');
    container.innerHTML='';
    if(data.error){ container.innerHTML='<p style="color:red">'+data.error+'</p>'; return; }
    data.users.forEach(u=>{
        const div = document.createElement('div');
        div.className='userCard';
        const avatar = u.avatar ? `<img src="${u.avatar}" class="avatar">` : '';
        div.innerHTML = `${avatar} <span>${u.name}</span>
            <div>
                <button class="chatBtn" onclick="openChat(${u.id},'${u.name}')">Chat</button>
                <button class="callBtn" onclick="callWhatsApp('${u.phone}')">Call</button>
            </div>`;
        container.appendChild(div);
    });
}

function openChat(id,name){
    sessionStorage.setItem('lastPage','contacts.html');
    window.location.href='chat.html?user_id='+id+'&name='+encodeURIComponent(name);
}

function callWhatsApp(phone){ if(!phone) return alert('No phone'); window.open('https://wa.me/'+phone,'_blank'); }

document.getElementById('search').addEventListener('input', e=>fetchUsers(e.target.value));
fetchUsers();
</script>
</body>
</html>
